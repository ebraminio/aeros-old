language: c

env:
  global:
    - secure: "cbS6v1eLwaqxl9Xc8XNPmA9JEPW/YKtruDOtiJpoQwhsVtnNt0ESnhwoVRtibzZFoX0MNWzBQgLqk8xPJSADp9j93bnu394z04i4rwoLSVIwHHelx5reeeTKaZR2nsO/cdY+KhtUK3pvhrDL0k+L++tDFhgSGlqahD5mnHvX1uhvQPO1mTyFg5/vUgdldvPGqXY9chZzxAHM5aCSyj7To0AkJRA9kN6JNCJVPGskq2YEaiWdOfdEHVpGkoiCE1NuD2Vv4di3dB1bWITO2p/9Gu9yqS4ab9wByl+0UacYjsZMaTLPtXlMJ8oDQCPjM3pBhjTl3r2uvWT7ye+2hz/56TOailsqUOUW866wDHEoW4rKuTg25W5JdUCnN9vxO32gHm3WEObdpen7eGcJKdFFXTXcOGAoiKt6zBMd8dIn05aPc8Uh0ED4qJ8UwG75Sb/Q7wVm8aZ2sMpoGyST0VRWVkF0fwYlC7VCw8T6ek2knypAUiwP5geXB0fx4PYbBFajKJnrc+htMEBKcwQrrW2KE0GV5nAEIup0IhwGZfmrN7hAkZClIQk2N3v1N+b4BJ60McR1W5gowtMxL5VEaCxrCx09UBHb4lE305H8AKRnacwb8vasnBHa24PleLj3V2eb1IjKZFiscG2DnidL+IyOH/WSCuhlZKBwzORrYc8yyWo="

addons:
  apt:
    packages:
      - autoconf2.64
      - texinfo
      - wget
      - lintian
      - fakeroot
  coverity_scan:
    project:
      name: "Aerath/aeros"
      description: ""
    notification_email: aerath.aiskurimu@gmail.com
    build_command_prepend: "if [[ ! -f $HOME/local/bin/i386-aeros-gcc ]]; then make -C toolchain binutils-install PREFIX=$HOME/local && make -C toolchain gcc-install PREFIX=$HOME/local; fi && cov-configure --comptype gcc --compiler $HOME/local/bin/i386-aeros-gcc"
    build_command: "make coverity"
    branch_pattern: coverity_scan

before_install:
  - echo -n | openssl s_client -connect scan.coverity.com:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' | sudo tee -a /etc/ssl/certs/ca-

script:
  - curl -s 'https://api.travis-ci.org/repos/Aerath/aeros/builds'
        --header 'accept:application/vnd.travis-ci.2+json'
        --header 'user-agent:MyClient/1.0.0' > travis-api.yml
  - export LAST_BUILT_COMMIT_ID=$(cat travis-api.yml | jq '[.builds[]|select(.state=="passed")][0].commit_id')
  - export LAST_BUILT_COMMIT_SHA=$(cat travis-api.yml | jq -r ".commits[]|select(.id==$LAST_BUILT_COMMIT_ID).sha")
  - export CHANGED_FILES="$(git diff-tree --no-commit-id --name-only -r $LAST_BUILT_COMMIT_SHA HEAD)"
  - echo "[TRAVIS] Changed files since last build ($LAST_BUILT_COMMIT_SHA) :"
  - for f in $CHANGED_FILES; do echo [TRAVIS] $f; done
  - export PATH="$PATH:$HOME/local/bin"
  - if echo "$CHANGED_FILES" | grep -q ".travis.yml\|toolchain\|lib/c";
    then make travis && export TRAVIS_DEPLOY=1;
    else echo [TRAVIS] Build not required;
    fi

after_failure:
  - cat toolchain/build-binutils/config.log
  - cat toolchain/build-gcc/config.log

before_deploy:
  - export TRAVIS_BINUTILS_ARTIFACT=$(ls toolchain/dist/*binutils*.deb)
  - export TRAVIS_GCC_ARTIFACT=$(ls toolchain/dist/*gcc*.deb)
  - wget https://api.travis-ci.org/jobs/$TRAVIS_JOB_ID/log.txt -O travis-job-$TRAVIS_JOB_ID.log

deploy:
  provider: releases
  api_key:
    secure: iWWzCnVxDklhVRB2ehJJzvS6tKRc5fQKq97DY9cv2CLEbmq+l/GLX6gKGnPF1zQuwDzWo69XilBaOa8GJb6n5+dz0IB8EJMBK/vvOu4mQWEmW7k+upfbnrRM9OZZfZAbYPx7YP6WuF29+b3fz+qQSlHLwa+R+NOJvMFW/BWcva6poJYEbAyI+BT61TNV2wxp7c+F3u3y3fVN4s0wxB6y3uanve3iSJUJ3itHN+Ov0KOC6hlc4J2oOM3gkPncFGzQHsUIoLAGH/Zwu5V1awy4fd/pye4XR9EWenZ/BxEAQf9WXAdajo+SI8ocNZ3KknjWi4dCdqpiBF3nXmjb63P3dgJWwCPYjU5WL2DETF6pGC7GyXn5lLJ3DhZz4RsYNhAi+8pj7CSysXKY2B2B2jB87oemTa6b2TjcR3cfHa4zzJqbR4v2o45KNJvH+A6lCWNHe/GAcOR2/x5cWRXXpOFvK/zlaVHuWOslnW8Si3SgSVUgxal0Pb3Eq1RBAjknFamlm9QXUcivWzqb2hp8TjlP+4VAcVVc2HPWyi5LYQz5XsnQvKqNn++hx18PGOlLoNgrLLc58UytHUg+bZpgd/ldyhKGoLEIgCQRAFbTEbu5jVgg77kJbMixiRaKac+/dlDpG2vv9YV8CjtAGEC9vE5Cfwaw6NIm2+12NXGY56VjJmk=
  file:
    - $TRAVIS_BINUTILS_ARTIFACT
    - $TRAVIS_GCC_ARTIFACT
    - travis-job-$TRAVIS_JOB_ID.log
  skip_cleanup: true
  on:
    condition: $TRAVIS_DEPLOY = 1
    repo: Aerath/aeros
    branch: develop

cache:
  - apt
  - directories:
      - $HOME/local
